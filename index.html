            input.accept = '.xlsx,.xls';
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        const foods = [];
                        data.forEach((r, i) => {
                            const name = r.Alim_Descrizione || r.Descrizione || r.Nome;
                            const cal = r.Alim_Calorie || r.Calorie;
                            if (name && cal) {
                                foods.push({
                                    id: r.Alim_Codice || ('F' + Date.now() + i),
                                    name: String(name).trim(),
                                    calories: parseInt(cal) || 0,
                                    refQty: parseFloat(r.Alim_Qta_Rif_Cal || r.Quantita || 100),
                                    unit: r.Alim_UM || r.UM || 'g'
                                });
                            }
                        });
                        if (foods.length && confirm(`Importare ${foods.length} alimenti? (Sostituisce)`)) {
                            DB.foods = foods;
                            saveData();
                            renderFoodList();
                            alert('Importazione completata!');
                        }
                    } catch(err) { alert('Errore: ' + err.message); }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            };
            input.click();
        }

        function exportMealsExcel() {
            const data = [['MovgioID', 'Mov_Data', 'Mov_ora', 'Mov_Cod_P', 'Mov_Descriz', 'Mov_Caloria', 'Mov_Qta', 'Mov_UM']];
            DB.meals.forEach(m => data.push([m.id, formatDateExcel(m.date), m.time, m.foodId, m.foodName, m.calories, m.qty, m.unit]));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Consumo_Giorno');
            XLSX.writeFile(wb, 'Consumo_Giorno.xlsx');
        }

        function importMealsExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false });
                        const meals = [];
                        data.forEach((r, i) => {
                            const date = parseDateExcel(r.Mov_Data || r.Data);
                            const name = r.Mov_Descriz || r.Descrizione;
                            if (date && name) {
                                meals.push({
                                    id: r.MovgioID || ('M' + Date.now() + i),
                                    date,
                                    time: parseTimeExcel(r.Mov_ora || r.Ora),
                                    foodId: r.Mov_Cod_P || ('IMP' + i),
                                    foodName: String(name).trim(),
                                    calories: parseInt(r.Mov_Caloria || r.Calorie) || 0,
                                    qty: parseFloat(r.Mov_Qta || r.Quantita) || 1,
                                    unit: r.Mov_UM || r.UM || 'g'
                                });
                            }
                        });
                        if (meals.length && confirm(`Importare ${meals.length} pasti? (Sostituisce)`)) {
                            DB.meals = meals;
                            saveData();
                            refreshDashboard();
                            if (document.getElementById('mealsView').classList.contains('active')) renderMealsList();
                            alert('Importazione completata!');
                        }
                    } catch(err) { alert('Errore: ' + err.message); }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            };
            input.click();
        }

        function exportWeightsExcel() {
            const data = [['Gio_Data', 'Gio_Peso', 'Gio_Desc']];
            [...DB.weights].sort((a,b) => a.date.localeCompare(b.date)).forEach(w => data.push([formatDateExcel(w.date), w.weight, w.note || '']));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Giorno');
            XLSX.writeFile(wb, 'Giorno.xlsx');
        }

        function importWeightsExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false });
                        const weights = [];
                        data.forEach(r => {
                            const date = parseDateExcel(r.Gio_Data || r.Data);
                            const peso = r.Gio_Peso || r.Peso;
                            if (date && peso) {
                                weights.push({
                                    date,
                                    weight: parseFloat(peso),
                                    note: r.Gio_Desc || r.Note || ''
                                });
                            }
                        });
                        if (weights.length && confirm(`Importare ${weights.length} pesi? (Sostituisce)`)) {
                            DB.weights = weights;
                            saveData();
                            renderWeightView();
                            refreshDashboard();
                            alert('Importazione completata!');
                        }
                    } catch(err) { alert('Errore: ' + err.message); }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            };
            input.click();
        }

        // =============================================
        // INIT
        // =============================================

        function init() {
            loadData();
            updateDateDisplay();
            refreshDashboard();
            document.getElementById('calorieGoalInput').value = DB.settings.calorieGoal;
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
